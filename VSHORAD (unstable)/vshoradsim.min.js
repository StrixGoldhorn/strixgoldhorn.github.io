/*v2.0.2a*/import*as THREE from"./modules/three.module.js";import*as dat from"./modules/datgui/dat.gui.module.js";import{OrbitControls}from"./modules/OrbitControls.js";import{GLTFLoader}from"./modules/GLTFLoader.min.js";import{OBB}from"./modules/OBB.js";var startSim=!1,rightClicked=!1;const scene=new THREE.Scene;document.getElementById("threeCanvas").scene=scene;var camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,8e3);const renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0,canvas:threeCanvas});var clock=new THREE.Clock;renderer.setSize(innerWidth,innerHeight),renderer.setPixelRatio(devicePixelRatio),document.body.appendChild(renderer.domElement),camera.position.set(0,2,0),scene.add(camera);const gui=new dat.GUI,worldSettings={scene:{randomise:function(){scene.remove(properplane),scene.remove(wireplane),generatePlane()}},c130:{pathx:1e3*Math.random()+500,pathy:1e3*Math.random()+500,zamp:500*Math.random(),zperiod:Math.random(),gndspeed:1e-4,agl:300*Math.random()+100,c130trackline:!0,tracklineAutoLength:!1},missile:{proxFuse:1.25,"accel factor":350},operator:{showStats:!1,zoomed:{focalLength:160,dampingFactor:.01},normal:{focalLength:20,dampingFactor:.05}}},sceneFolder=gui.addFolder("scene");sceneFolder.add(worldSettings.scene,"randomise");const c130Folder=gui.addFolder("c130");c130Folder.add(worldSettings.c130,"pathx",100,5e3,50),c130Folder.add(worldSettings.c130,"pathy",100,5e3,50),c130Folder.add(worldSettings.c130,"zamp",0,1e3,1),c130Folder.add(worldSettings.c130,"zperiod",0,10,.01),c130Folder.add(worldSettings.c130,"gndspeed",1e-4,.005),c130Folder.add(worldSettings.c130,"agl",0,500,10),c130Folder.add(worldSettings.c130,"c130trackline"),c130Folder.add(worldSettings.c130,"tracklineAutoLength");const missileFolder=gui.addFolder("missile");missileFolder.add(worldSettings.missile,"proxFuse",1.25,5),missileFolder.add(worldSettings.missile,"accel factor",0,500,50);const operatorFolder=gui.addFolder("operator");operatorFolder.add(worldSettings.operator,"showStats");const zoomedFolder=operatorFolder.addFolder("zoomed");zoomedFolder.add(worldSettings.operator.zoomed,"focalLength",50,500),zoomedFolder.add(worldSettings.operator.zoomed,"dampingFactor",.001,.1);const normalFolder=operatorFolder.addFolder("normal");normalFolder.add(worldSettings.operator.normal,"focalLength",0,50),normalFolder.add(worldSettings.operator.normal,"dampingFactor",.01,.1);const sbLoad=new THREE.CubeTextureLoader;let sbTexture,sbTop,sbBg,properplane,wireplane,controls;function generatePlane(){const e=100,t=new THREE.PlaneGeometry(1e4,1e4,e,e),o=new THREE.MeshBasicMaterial({color:34816,side:THREE.DoubleSide,wireframe:!0});wireplane=new THREE.Mesh(t,o),wireplane.rotation.set(Math.PI/2,0,0),wireplane.position.set(0,.1,0),scene.add(wireplane);const n=wireplane.geometry.attributes.position.array;var r=0;for(let e=0;e<n.length;e+=3){const t=n[e+2];var a=0,i=15*Math.random();a=Math.random()>.2?i:-i,n[e+2]=t+r+a,r=a}const s=t.clone(),c=new THREE.MeshBasicMaterial({color:7647338,side:THREE.DoubleSide});properplane=new THREE.Mesh(s,c),properplane.rotation.set(Math.PI/2,0,0),wireplane.position.y+=n[15302],properplane.position.y+=n[15302],scene.add(properplane)}function setControls(){camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,5e3),controls=new OrbitControls(camera,renderer.domElement),controls.addEventListener("change",(()=>{renderer.render(scene,camera)})),controls.target.set(.5,2.6,0),controls.enablePan=!1,controls.enableZoom=!1,controls.maxPolarAngle=Math.PI/12*10,controls.minPolarAngle=Math.PI/12*5}window.innerWidth<=1e3?(sbBg="./assets/skybox/bg.min.png",sbTop="./assets/skybox/top.min.png"):(sbBg="./assets/skybox/bg.png",sbTop="./assets/skybox/top.png"),sbTexture=sbLoad.load([sbBg,sbBg,sbTop,sbTop,sbBg,sbBg]),scene.background=sbTexture,generatePlane(),renderer.render(scene,camera),setControls();const loader=new GLTFLoader,missileLight=new THREE.PointLight(13411346,6,1,1),sphereSize=1,pointLightHelper=new THREE.PointLightHelper(missileLight,1);function loadMissile(){let e;e=window.innerWidth<=1e3?"assets/rbs70missile_scaled_1_5 (MIN).glb":"assets/rbs70missile_scaled_1_5_(EXPORT).glb",loader.load(e,(e=>{const t=e.scene;if(t.scale.set(.1*t.scale.x,.1*t.scale.y,.1*t.scale.z),t.position.set(0,2,0),t.name="MissileMesh",scene.add(t),renderer.render(scene,camera),window.innerWidth>1e3){const t=e.animations,o=new THREE.AnimationMixer(e.scene);t.forEach((t=>{const n=e.animations.find((e=>e.name===t.name)),r=o.clipAction(n);r.clampWhenFinished=!0,r.loop=THREE.LoopOnce,r.play(),renderer.render(scene,camera)})),function e(){o.timeScale=10,o.update(clock.getDelta()),requestAnimationFrame(e)}()}renderer.render(scene,camera)}))}let wpnpath,standpath,c130path;scene.add(pointLightHelper),scene.add(missileLight),missileLight.position.set(0,-50,0),wpnpath=window.innerWidth<=1e3?"assets/rbs70_WEAPON_scaled_1_5_(MIN).glb":"assets/rbs70_WEAPON_scaled_1_5_(EXPORT).glb",loader.load(wpnpath,(e=>{const t=e.scene;t.scale.set(.2*t.scale.x,.2*t.scale.y,.2*t.scale.z),t.position.set(0,1.8,0),t.name="WeaponMesh",scene.add(t),renderer.render(scene,camera)})),standpath=window.innerWidth<=1e3?"assets/rbs70_STAND_scaled_1_5_(MIN).glb":"assets/rbs70_STAND_scaled_1_5_(EXPORT).glb",loader.load(standpath,(e=>{const t=e.scene;t.scale.set(.2*t.scale.x,.2*t.scale.y,.2*t.scale.z),t.name="StandMesh",scene.add(t),renderer.render(scene,camera)})),loader.load("assets/rbs70_SEAT_scaled_1_5_(EXPORT).glb",(e=>{const t=e.scene;t.scale.set(.2*t.scale.x,.2*t.scale.y,.2*t.scale.z),t.name="SeatMesh",scene.add(t),renderer.render(scene,camera)})),c130path=window.innerWidth<=1e3?"assets/c130_(EXPORT MIN).glb":"assets/c130_(EXPORT).glb",loader.load(c130path,(e=>{const t=e.scene;t.name="c130Mesh",scene.add(t),t.position.set(0,20,0),renderer.render(scene,camera),c130anim()}));var c130t=0,c130hit=!1,c130TrackLine=[];let cTrackLine;const c130Material=new THREE.LineBasicMaterial({color:16711935,linewidth:1});var c130halfSize=new THREE.Vector3(10,10,10),c130Pt=new THREE.Vector3,c130TLGeometry=new THREE.BufferGeometry;function c130anim(){if(c130hit)return;const e=scene.children.find((e=>"c130Mesh"===e.name)).children[0];e.geometry.computeBoundingBox(),c130t+=worldSettings.c130.gndspeed,e.position.x=worldSettings.c130.pathx*Math.cos(c130t),e.position.z=worldSettings.c130.pathy*Math.sin(c130t),e.position.y=worldSettings.c130.agl+worldSettings.c130.zamp*Math.sin(worldSettings.c130.zperiod*c130t)**2,e.lookAt(0,0,0),e.rotateX(Math.PI/8),e.userData.obb=new OBB,e.userData.obb.applyMatrix4(e.matrixWorld),e.userData.obb.halfSize=c130halfSize,!0===worldSettings.c130.c130trackline?(c130TrackLine.length>500&&!0===worldSettings.c130.tracklineAutoLength&&c130TrackLine.shift(),scene.remove(cTrackLine),e.getWorldPosition(c130Pt),c130TrackLine.push(c130Pt.clone()),c130TLGeometry.setFromPoints(c130TrackLine),cTrackLine=new THREE.Line(c130TLGeometry,c130Material),c130TLGeometry.dispose(),scene.add(cTrackLine)):c130TrackLine=[],requestAnimationFrame(c130anim)}function c130hitcam(){const e=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,5e3),t=scene.children.find((e=>"c130Mesh"===e.name)).children[0];e.position.set(t.position.x,t.position.y+2,t.position.z)}const directionalLight=new THREE.DirectionalLight(16775395,3);directionalLight.position.set(200,1e3,500),scene.add(directionalLight);const pointLight=new THREE.PointLight(16775395,2);function animate(){renderer.render(scene,camera),requestAnimationFrame(animate),0===controls&&rotateWpn(),controls.update()}pointLight.position.set(0,1500,0),scene.add(pointLight),animate();var alignWpnVector=new THREE.Vector3,focalWpn=new THREE.Vector3,focalSeat=new THREE.Vector3;function rotateWpn(){const e=scene.children.find((e=>"WeaponMesh"===e.name)),t=scene.children.find((e=>"SeatMesh"===e.name));focalWpn.set(e.position.x+camera.getWorldDirection(alignWpnVector).x,e.position.y+camera.getWorldDirection(alignWpnVector).y,e.position.z+camera.getWorldDirection(alignWpnVector).z),focalSeat.set(t.position.x+camera.getWorldDirection(alignWpnVector).x,t.position.y,t.position.z+camera.getWorldDirection(alignWpnVector).z),e.lookAt(focalWpn),t.lookAt(focalSeat),requestAnimationFrame(rotateWpn)}var shiftDown=!1;const cageNotify=document.getElementById("cage");function cageActions(){!shiftDown||window.innerWidth<=1e3&&!tpCache.includes("mobileCage")?(cageNotify.innerText="-CAGED-",cageNotify.style.background="#dd2222"):(cageNotify.innerText="UNCAGED",cageNotify.style.background="#22cc55")}var fired=!1,shotout=!1,shotend=!1;const missileBox=new THREE.Box3,loadIndicate=document.getElementById("loadIndicate"),tempCross=document.getElementById("tempCross");var currdist=0,rotateAnim=0;const alertDoc=document.getElementById("alert"),missileTrackLine=[];missileTrackLine.push(new THREE.Vector3(0,2,0));var mTLcount=0;const mTLMaterial=new THREE.LineBasicMaterial({color:255,linewidth:1});var s,a,t,mTLGeometry=(new THREE.BufferGeometry).setFromPoints(missileTrackLine),TrackLine=new THREE.Line(mTLGeometry,mTLMaterial),speedclock=new THREE.Clock(!1),currspeed=50,curraccel=worldSettings.missile["accel factor"];function missiledist(e){return e>686&&(curraccel=-10),a=curraccel,t=speedclock.getDelta(),currspeed=e+a*t,s=e*t+.5*a*t*t}alignWpnVector=new THREE.Vector3;var longFocal=new THREE.Vector3,missilePt=(focalWpn=new THREE.Vector3,new THREE.Vector3);mTLGeometry=new THREE.BufferGeometry;function fire(){if(fired||!shiftDown||shotend)fired||shotout?(console.log("- ! - No munition"),loadIndicate.style.background="#dd2222",loadIndicate.innerText="Empty",loadIndicate.style.color="white"):(console.log("- ! - CAGED, Cannot fire"),alertDoc.innerText="Uncage to fire!",alertDoc.style.opacity="1",alertDoc.style.background="#dd2222");else{requestAnimationFrame(fire),shotout||(loadMissile(),animate(),scene.add(missileLight),missileLight.intensity=10,shotout=!0,console.log("- ^ - Missile fired"),loadIndicate.style.background="yellow",loadIndicate.innerText="In-Flight",loadIndicate.style.color="black",alertDoc.innerText="",alertDoc.style.opacity="0",speedclock.start());const e=scene.children.find((e=>"MissileMesh"===e.name)),t=e.children.find((e=>"Fuse"===e.name));t.geometry.computeBoundingBox(),missileBox.copy(t.geometry.boundingBox).applyMatrix4(t.matrixWorld),missileBox.expandByScalar(worldSettings.missile.proxFuse),worldSettings.operator.showStats&&(tempCross.innerHTML="------ <br /> "+("000"+Math.round(currspeed)).slice(-4)+" | + | "+("000"+Math.round(parseFloat(currdist/10).toFixed(4))).slice(-3)+"0<br />------"),focalWpn.set(camera.getWorldDirection(alignWpnVector).x,camera.getWorldDirection(alignWpnVector).y,camera.getWorldDirection(alignWpnVector).z),longFocal=focalWpn.clone(),focalWpn.normalize(),focalWpn.multiplyScalar(currdist),focalWpn.setY(focalWpn.y+2),currdist+=missiledist(currspeed),e.getWorldPosition(missilePt),e.lookAt(longFocal.multiplyScalar(1e4)),e.rotateZ(rotateAnim*(Math.PI/180)),rotateAnim+=2,missileLight.position.set(e.position.x-.5,e.position.y,e.position.z),e.position.set(focalWpn.x,focalWpn.y,focalWpn.z),5===mTLcount?(missileTrackLine.push(missilePt),mTLcount=0):mTLcount+=1;const o=scene.children.find((e=>"c130Mesh"===e.name)).children[0];if(o.userData.obb.intersectsBox3(missileBox)&&(missileLight.intensity=10,missileLight.distance=10,shotend=!0,console.log("- - - SUCCESSFUL HIT - - -"),tempCross.innerHTML="------ <br />| HIT | <br />------",missileTrackLine.push(missilePt),mTLGeometry.setFromPoints(missileTrackLine),TrackLine=new THREE.Line(mTLGeometry,mTLMaterial),scene.add(TrackLine),camera.position.set(o.position.x,o.position.y+50,o.position.z),controls.target.set(o.position.x,o.position.y+20,o.position.z),controls.enablePan=!0,controls.enableZoom=!0,camera.setFocalLength(worldSettings.operator.normal.focalLength),controls.dampingFactor=worldSettings.operator.normal.dampingFactor,controls.maxPolarAngle=Math.PI,controls.minPolarAngle=0,controls.update()),o.userData.obb.intersectsBox3(missileBox))return c130hit=!0,void c130hitcam();(Math.round(missilePt.length())>9e3||Math.round(e.position.y)>5500)&&(shotend=!0,console.log("- ! - Max Range Exceeded"),mTLGeometry.setFromPoints(missileTrackLine),TrackLine=new THREE.Line(mTLGeometry,mTLMaterial),scene.add(TrackLine),tempCross.innerHTML="------ <br />|-=!=-|<br />------",alertDoc.innerText="Max Range",alertDoc.style.opacity="1",alertDoc.style.background="#dd2222")}console.log(scene)}function startActions(){!1===fired&&(console.log("- - - START - - -"),startSim=!0,controls.enableDamping=!0,controls.dampingFactor=.05,controls.rotateSpeed=.2,rotateWpn(),cageActions(),loadIndicate.style.background="#22cc55",loadIndicate.innerText="Loaded",loadIndicate.style.color="white",tempCross.innerHTML="------ <br />| + | <br />------",alertDoc.innerText="",alertDoc.style.opacity="0",document.getElementById("notifsbg").remove(),directionalLight.target=scene.children.find((e=>"WeaponMesh"===e.name)).children[0])}function fireActions(){startSim&&(alertDoc.innerText="",alertDoc.style.opacity="0",fire())}function reloadActions(){if(!startSim)return;shotout=!1,fired=!1,shotend=!1,currdist=0,currspeed=50,curraccel=57,speedclock.stop(),curraccel=worldSettings.missile["accel factor"],c130hit&&(c130hit=!1,c130anim()),missileTrackLine.length=0,missileTrackLine.push(new THREE.Vector3(0,2,0)),scene.remove(TrackLine);const e=scene.children.find((e=>"MissileMesh"===e.name));scene.remove(missileLight),scene.remove(e),console.log("--- Missile reset ---"),loadIndicate.style.background="#22cc55",loadIndicate.innerText="Loaded",loadIndicate.style.color="white",tempCross.innerHTML="------ <br /> | + | <br />------",camera.position.set(0,2,-2),controls.enablePan=!1,controls.enableZoom=!1,controls.maxPolarAngle=Math.PI/12*10,controls.minPolarAngle=Math.PI/12*5,controls.target.set(.5,2.6,0),controls.update()}function flash1(){alertDoc.style.background="rgb(34, 204, 85)"==alertDoc.style.background?"#dd2222":"#22cc55"}function winresize(){const e=window.innerWidth,t=window.innerHeight;camera.aspect=e/t,camera.updateProjectionMatrix(),renderer.setSize(e,t)}renderer.render(scene,camera),document.addEventListener("contextmenu",(()=>{startSim&&!c130hit&&((rightClicked=!rightClicked)?(camera.setFocalLength(worldSettings.operator.zoomed.focalLength),controls.dampingFactor=worldSettings.operator.zoomed.dampingFactor):(camera.setFocalLength(worldSettings.operator.normal.focalLength),controls.dampingFactor=worldSettings.operator.normal.dampingFactor),camera.updateProjectionMatrix())})),document.addEventListener("keypress",(e=>{switch(e.key){case" ":startActions();break;case"c":fireActions();break;case"r":reloadActions()}})),setInterval(flash1,800),document.addEventListener("keydown",(e=>{startSim&&("Shift"===e.key&&(shiftDown=!0,cageActions()),"C"===e.key&&((shotout||fired)&&console.log("- ! - No munition"),fire()))})),document.addEventListener("keyup",(e=>{startSim&&("Shift"===e.key&&(shiftDown=!1,shotout&&(shotend=!0),cageActions()),"c"===e.key&&cageActions())})),window.addEventListener("resize",(e=>{setInterval(winresize,500)})),function(){var e=document.createElement("script");e.onload=function(){var e=new Stats;document.body.appendChild(e.dom),requestAnimationFrame((function t(){e.update(),requestAnimationFrame(t)}))},e.src="//mrdoob.github.io/stats.js/build/stats.min.js",document.head.appendChild(e)}();const tpCache=[];document.getElementById("mobileCage").ontouchstart=function(){startSim&&(tpCache.push("mobileCage"),shiftDown=!0,cageActions())},document.getElementById("mobileCage").ontouchend=function(){startSim&&(tpCache.splice(tpCache.indexOf("mobileCage"),1),shiftDown=!1,cageActions())},document.getElementById("mobileFire").ontouchstart=function(){fireActions()},document.getElementById("mobileReload").ontouchstart=function(){reloadActions()},document.getElementById("mobileStart").ontouchstart=function(){document.getElementById("mobileStart").style.display="none",startActions()};