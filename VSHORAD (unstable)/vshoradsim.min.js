/*v2.0.1a*/import*as b from"./modules/three.module.js";import*as c from"./modules/datgui/dat.gui.module.js";import{OrbitControls as e}from"./modules/OrbitControls.js";import{GLTFLoader as d}from"./modules/GLTFLoader.min.js";import{OBB as f}from"./modules/OBB.js";var s,a,t,startSim=!1,rightClicked=!1;let scene=new b.Scene;document.getElementById("threeCanvas").scene=scene;var camera=new b.PerspectiveCamera(75,innerWidth/innerHeight,.1,8e3);let renderer=new b.WebGLRenderer({alpha:!0,antialias:!0,canvas:threeCanvas});var clock=new b.Clock;renderer.setSize(innerWidth,innerHeight),renderer.setPixelRatio(devicePixelRatio),document.body.appendChild(renderer.domElement),camera.position.set(0,2,0),scene.add(camera);let gui=new c.GUI,worldSettings={scene:{randomise:function(){scene.remove(properplane),scene.remove(wireplane),generatePlane()}},c130:{pathx:1e3*Math.random()+500,pathy:1e3*Math.random()+500,zamp:500*Math.random(),zperiod:Math.random(),gndspeed:1e-4,agl:300*Math.random()+100,c130trackline:!0,tracklineAutoLength:!1},missile:{proxFuse:1.25,"accel factor":350},operator:{showStats:!1,zoomed:{focalLength:160,dampingFactor:.01},normal:{focalLength:20,dampingFactor:.05}}},sceneFolder=gui.addFolder("scene");sceneFolder.add(worldSettings.scene,"randomise");let c130Folder=gui.addFolder("c130");c130Folder.add(worldSettings.c130,"pathx",100,5e3,50),c130Folder.add(worldSettings.c130,"pathy",100,5e3,50),c130Folder.add(worldSettings.c130,"zamp",0,1e3,1),c130Folder.add(worldSettings.c130,"zperiod",0,10,.01),c130Folder.add(worldSettings.c130,"gndspeed",1e-4,.005),c130Folder.add(worldSettings.c130,"agl",0,500,10),c130Folder.add(worldSettings.c130,"c130trackline"),c130Folder.add(worldSettings.c130,"tracklineAutoLength");let missileFolder=gui.addFolder("missile");missileFolder.add(worldSettings.missile,"proxFuse",1.25,5),missileFolder.add(worldSettings.missile,"accel factor",0,500,50);let operatorFolder=gui.addFolder("operator");operatorFolder.add(worldSettings.operator,"showStats");let zoomedFolder=operatorFolder.addFolder("zoomed");zoomedFolder.add(worldSettings.operator.zoomed,"focalLength",50,500),zoomedFolder.add(worldSettings.operator.zoomed,"dampingFactor",.001,.1);let normalFolder=operatorFolder.addFolder("normal");normalFolder.add(worldSettings.operator.normal,"focalLength",0,50),normalFolder.add(worldSettings.operator.normal,"dampingFactor",.01,.1);let sbLoad=new b.CubeTextureLoader,sbTexture,sbTop,sbBg;window.innerWidth<=1e3?(sbBg="./assets/skybox/bg.min.png",sbTop="./assets/skybox/top.min.png"):(sbBg="./assets/skybox/bg.png",sbTop="./assets/skybox/top.png"),sbTexture=sbLoad.load([sbBg,sbBg,sbTop,sbTop,sbBg,sbBg]),scene.background=sbTexture;let properplane,wireplane;function generatePlane(){let f=new b.PlaneGeometry(1e4,1e4,100,100),i=new b.MeshBasicMaterial({color:34816,side:b.DoubleSide,wireframe:!0});(wireplane=new b.Mesh(f,i)).rotation.set(Math.PI/2,0,0),wireplane.position.set(0,.1,0),scene.add(wireplane);let c=wireplane.geometry.attributes.position.array;var g=0;for(let d=0;d<c.length;d+=3){let j=c[d+2];var e=0,h=15*Math.random();e=Math.random()>.2?h:-h,c[d+2]=j+g+e,g=e}let k=f.clone(),l=new b.MeshBasicMaterial({color:7647338,side:b.DoubleSide});(properplane=new b.Mesh(k,l)).rotation.set(Math.PI/2,0,0),wireplane.position.y+=c[15302],properplane.position.y+=c[15302],scene.add(properplane)}generatePlane(),renderer.render(scene,camera);let controls;function setControls(){camera=new b.PerspectiveCamera(75,innerWidth/innerHeight,.1,5e3),(controls=new e(camera,renderer.domElement)).addEventListener("change",()=>{renderer.render(scene,camera)}),controls.target.set(.5,2.6,0),controls.enablePan=!1,controls.enableZoom=!1,controls.maxPolarAngle=10*(Math.PI/12),controls.minPolarAngle=5*(Math.PI/12)}setControls();let loader=new d,missileLight=new b.PointLight(13411346,6,1,1),sphereSize=1,pointLightHelper=new b.PointLightHelper(missileLight,1);function loadMissile(){let c;c=window.innerWidth<=1e3?"assets/rbs70missile_scaled_1_5 (MIN).glb":"assets/rbs70missile_scaled_1_5_(EXPORT).glb",loader.load(c,d=>{let c=d.scene;if(c.scale.set(.1*c.scale.x,.1*c.scale.y,.1*c.scale.z),c.position.set(0,2,0),c.name="MissileMesh",scene.add(c),renderer.render(scene,camera),window.innerWidth>1e3){let e=d.animations,g=new b.AnimationMixer(d.scene);function f(){g.timeScale=10,g.update(clock.getDelta()),requestAnimationFrame(f)}e.forEach(f=>{let e=d.animations.find(b=>b.name===f.name),c=g.clipAction(e);c.clampWhenFinished=!0,c.loop=b.LoopOnce,c.play(),renderer.render(scene,camera)}),f()}renderer.render(scene,camera)})}scene.add(pointLightHelper),scene.add(missileLight),missileLight.position.set(0,-50,0);let wpnpath;wpnpath=window.innerWidth<=1e3?"assets/rbs70_WEAPON_scaled_1_5_(MIN).glb":"assets/rbs70_WEAPON_scaled_1_5_(EXPORT).glb",loader.load(wpnpath,c=>{let b=c.scene;b.scale.set(.2*b.scale.x,.2*b.scale.y,.2*b.scale.z),b.position.set(0,1.8,0),b.name="WeaponMesh",scene.add(b),renderer.render(scene,camera)});let standpath;standpath=window.innerWidth<=1e3?"assets/rbs70_STAND_scaled_1_5_(MIN).glb":"assets/rbs70_STAND_scaled_1_5_(EXPORT).glb",loader.load(standpath,c=>{let b=c.scene;b.scale.set(.2*b.scale.x,.2*b.scale.y,.2*b.scale.z),b.name="StandMesh",scene.add(b),renderer.render(scene,camera)}),loader.load("assets/rbs70_SEAT_scaled_1_5_(EXPORT).glb",c=>{let b=c.scene;b.scale.set(.2*b.scale.x,.2*b.scale.y,.2*b.scale.z),b.name="SeatMesh",scene.add(b),renderer.render(scene,camera)});let c130path;c130path=window.innerWidth<=1e3?"assets/c130_(EXPORT MIN).glb":"assets/c130_(EXPORT).glb",loader.load(c130path,c=>{let b=c.scene;b.name="c130Mesh",scene.add(b),b.position.set(0,20,0),renderer.render(scene,camera),c130anim()});var c130t=0,c130hit=!1,c130TrackLine=[];let c130TLGeometry,cTrackLine,c130Material=new b.LineBasicMaterial({color:16711935,linewidth:1});function c130anim(){if(c130hit)return;let c=scene.children.find(b=>"c130Mesh"===b.name).children[0];if(c.geometry.computeBoundingBox(),c130t+=worldSettings.c130.gndspeed,c.position.x=worldSettings.c130.pathx*Math.cos(c130t),c.position.z=worldSettings.c130.pathy*Math.sin(c130t),c.position.y=worldSettings.c130.agl+worldSettings.c130.zamp*Math.sin(worldSettings.c130.zperiod*c130t)**2,c.lookAt(0,0,0),c.rotateX(Math.PI/8),c.userData.obb=new f,c.userData.obb.applyMatrix4(c.matrixWorld),c.userData.obb.halfSize=new b.Vector3(10,10,10),!0===worldSettings.c130.c130trackline){c130TrackLine.length>500&& !0===worldSettings.c130.tracklineAutoLength&&c130TrackLine.shift(),scene.remove(cTrackLine);var d=new b.Vector3;c.getWorldPosition(d),c130TrackLine.push(d),c130TLGeometry=new b.BufferGeometry().setFromPoints(c130TrackLine),cTrackLine=new b.Line(c130TLGeometry,c130Material),c130TLGeometry.dispose(),scene.add(cTrackLine)}else c130TrackLine=[];requestAnimationFrame(c130anim)}function c130hitcam(){let d=new b.PerspectiveCamera(75,innerWidth/innerHeight,.1,5e3),c=scene.children.find(b=>"c130Mesh"===b.name).children[0];d.position.set(c.position.x,c.position.y+2,c.position.z)}let directionalLight=new b.DirectionalLight(16775395,3);directionalLight.position.set(200,1e3,500),scene.add(directionalLight);let pointLight=new b.PointLight(16775395,2);function animate(){renderer.render(scene,camera),requestAnimationFrame(animate),0===controls&&rotateWpn(),controls.update()}function rotateWpn(){let d=scene.children.find(b=>"WeaponMesh"===b.name),e=scene.children.find(b=>"SeatMesh"===b.name);var c=new b.Vector3,f=new b.Vector3(d.position.x+camera.getWorldDirection(c).x,d.position.y+camera.getWorldDirection(c).y,d.position.z+camera.getWorldDirection(c).z),g=new b.Vector3(e.position.x+camera.getWorldDirection(c).x,e.position.y,e.position.z+camera.getWorldDirection(c).z);d.lookAt(f),e.lookAt(g),requestAnimationFrame(rotateWpn)}pointLight.position.set(0,1500,0),scene.add(pointLight),animate();var shiftDown=!1;let cageNotify=document.getElementById("cage");function cageActions(){shiftDown&&(!(window.innerWidth<=1e3)||tpCache.includes("mobileCage"))?(cageNotify.innerText="UNCAGED",cageNotify.style.background="#22cc55"):(cageNotify.innerText="-CAGED-",cageNotify.style.background="#dd2222")}var fired=!1,shotout=!1,shotend=!1;let missileBox=new b.Box3,loadIndicate=document.getElementById("loadIndicate"),tempCross=document.getElementById("tempCross");var currdist=0,rotateAnim=0;let alertDoc=document.getElementById("alert"),missileTrackLine=[];missileTrackLine.push(new b.Vector3(0,2,0));var mTLcount=0;let mTLMaterial=new b.LineBasicMaterial({color:255,linewidth:1});var mTLGeometry=new b.BufferGeometry().setFromPoints(missileTrackLine),TrackLine=new b.Line(mTLGeometry,mTLMaterial),speedclock=new b.Clock(!1),currspeed=50,curraccel=worldSettings.missile["accel factor"];function missiledist(b){return b>686&&(curraccel=-10),a=curraccel,s=b*(t=speedclock.getDelta())+.5*a*t*t,currspeed=b+a*t,s}function fire(){if(fired||!shiftDown||shotend)fired||shotout?(console.log("- ! - No munition"),loadIndicate.style.background="#dd2222",loadIndicate.innerText="Empty",loadIndicate.style.color="white"):(console.log("- ! - CAGED, Cannot fire"),alertDoc.innerText="Uncage to fire!",alertDoc.style.opacity="1",alertDoc.style.background="#dd2222");else{requestAnimationFrame(fire),shotout||(loadMissile(),animate(),scene.add(missileLight),missileLight.intensity=10,shotout=!0,console.log("- ^ - Missile fired"),loadIndicate.style.background="yellow",loadIndicate.innerText="In-Flight",loadIndicate.style.color="black",alertDoc.innerText="",alertDoc.style.opacity="0",speedclock.start());let c=scene.children.find(b=>"MissileMesh"===b.name),g=c.children.find(b=>"Fuse"===b.name);g.geometry.computeBoundingBox(),missileBox.copy(g.geometry.boundingBox).applyMatrix4(g.matrixWorld),missileBox.expandByScalar(worldSettings.missile.proxFuse),worldSettings.operator.showStats&&(tempCross.innerHTML="------ <br /> "+("000"+Math.round(currspeed)).slice(-4)+" | + | "+("000"+Math.round(parseFloat(currdist/10).toFixed(4))).slice(-3)+"0<br />------");var h=new b.Vector3,i=new b.Vector3,d=new b.Vector3(camera.getWorldDirection(h).x,camera.getWorldDirection(h).y,camera.getWorldDirection(h).z);i=d.clone(),d.normalize(),d.multiplyScalar(currdist),d.setY(d.y+2),currdist+=missiledist(currspeed);var f=new b.Vector3;c.getWorldPosition(f),c.lookAt(i.multiplyScalar(1e4)),c.rotateZ(rotateAnim*(Math.PI/180)),rotateAnim+=2,missileLight.position.set(c.position.x-.5,c.position.y,c.position.z),c.position.set(d.x,d.y,d.z),5===mTLcount?(missileTrackLine.push(f),mTLcount=0):mTLcount+=1;let e=scene.children.find(b=>"c130Mesh"===b.name).children[0];if(e.userData.obb.intersectsBox3(missileBox)&&(missileLight.intensity=10,missileLight.distance=10,shotend=!0,console.log("- - - SUCCESSFUL HIT - - -"),tempCross.innerHTML="------ <br />| HIT | <br />------",missileTrackLine.push(f),mTLGeometry=new b.BufferGeometry().setFromPoints(missileTrackLine),TrackLine=new b.Line(mTLGeometry,mTLMaterial),scene.add(TrackLine),camera.position.set(e.position.x,e.position.y+50,e.position.z),controls.target.set(e.position.x,e.position.y+20,e.position.z),controls.enablePan=!0,controls.enableZoom=!0,camera.setFocalLength(worldSettings.operator.normal.focalLength),controls.dampingFactor=worldSettings.operator.normal.dampingFactor,controls.maxPolarAngle=Math.PI,controls.minPolarAngle=0,controls.update()),e.userData.obb.intersectsBox3(missileBox)){c130hit=!0,c130hitcam();return}(Math.round(f.length())>9e3||Math.round(c.position.y)>5500)&&(shotend=!0,console.log("- ! - Max Range Exceeded"),mTLGeometry=new b.BufferGeometry().setFromPoints(missileTrackLine),TrackLine=new b.Line(mTLGeometry,mTLMaterial),scene.add(TrackLine),tempCross.innerHTML="------ <br />|-=!=-|<br />------",alertDoc.innerText="Max Range",alertDoc.style.opacity="1",alertDoc.style.background="#dd2222")}}function startActions(){!1===fired&&(console.log("- - - START - - -"),startSim=!0,controls.enableDamping=!0,controls.dampingFactor=.05,controls.rotateSpeed=.2,rotateWpn(),cageActions(),loadIndicate.style.background="#22cc55",loadIndicate.innerText="Loaded",loadIndicate.style.color="white",tempCross.innerHTML="------ <br />| + | <br />------",alertDoc.innerText="",alertDoc.style.opacity="0",document.getElementById("notifsbg").remove(),directionalLight.target=scene.children.find(b=>"WeaponMesh"===b.name).children[0])}function fireActions(){startSim&&(alertDoc.innerText="",alertDoc.style.opacity="0",fire())}function reloadActions(){if(!startSim)return;shotout=!1,fired=!1,shotend=!1,currdist=0,currspeed=50,curraccel=57,speedclock.stop(),curraccel=worldSettings.missile["accel factor"],c130hit&&(c130hit=!1,c130anim()),missileTrackLine.length=0,missileTrackLine.push(new b.Vector3(0,2,0)),scene.remove(TrackLine);let c=scene.children.find(b=>"MissileMesh"===b.name);scene.remove(missileLight),scene.remove(c),console.log("--- Missile reset ---"),loadIndicate.style.background="#22cc55",loadIndicate.innerText="Loaded",loadIndicate.style.color="white",tempCross.innerHTML="------ <br /> | + | <br />------",camera.position.set(0,2,-2),controls.enablePan=!1,controls.enableZoom=!1,controls.maxPolarAngle=10*(Math.PI/12),controls.minPolarAngle=5*(Math.PI/12),controls.target.set(.5,2.6,0),controls.update()}function flash1(){alertDoc.style.background="rgb(34, 204, 85)"==alertDoc.style.background?"#dd2222":"#22cc55"}function winresize(){let b=window.innerWidth,c=window.innerHeight;camera.aspect=b/c,camera.updateProjectionMatrix(),renderer.setSize(b,c)}renderer.render(scene,camera),document.addEventListener("contextmenu",()=>{startSim&&!c130hit&&((rightClicked=!rightClicked)?(camera.setFocalLength(worldSettings.operator.zoomed.focalLength),controls.dampingFactor=worldSettings.operator.zoomed.dampingFactor):(camera.setFocalLength(worldSettings.operator.normal.focalLength),controls.dampingFactor=worldSettings.operator.normal.dampingFactor),camera.updateProjectionMatrix())}),document.addEventListener("keypress",b=>{switch(b.key){case" ":startActions();break;case"c":fireActions();break;case"r":reloadActions()}}),setInterval(flash1,800),document.addEventListener("keydown",b=>{startSim&&("Shift"===b.key&&(shiftDown=!0,cageActions()),"C"===b.key&&((shotout||fired)&&console.log("- ! - No munition"),fire()))}),document.addEventListener("keyup",b=>{startSim&&("Shift"===b.key&&(shiftDown=!1,shotout&&(shotend=!0),cageActions()),"c"===b.key&&cageActions())}),window.addEventListener("resize",b=>{setInterval(winresize,500)}),function(){var b=document.createElement("script");b.onload=function(){var b=new Stats;document.body.appendChild(b.dom),requestAnimationFrame(function c(){b.update(),requestAnimationFrame(c)})},b.src="//mrdoob.github.io/stats.js/build/stats.min.js",document.head.appendChild(b)}();let tpCache=[];document.getElementById("mobileCage").ontouchstart=function(){startSim&&(tpCache.push("mobileCage"),shiftDown=!0,cageActions())},document.getElementById("mobileCage").ontouchend=function(){startSim&&(tpCache.splice(tpCache.indexOf("mobileCage"),1),shiftDown=!1,cageActions())},document.getElementById("mobileFire").ontouchstart=function(){fireActions()},document.getElementById("mobileReload").ontouchstart=function(){reloadActions()},document.getElementById("mobileStart").ontouchstart=function(){document.getElementById("mobileStart").style.display="none",startActions()}